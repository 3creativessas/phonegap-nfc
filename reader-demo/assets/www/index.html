<!DOCTYPE HTML>
<html>
<head>

<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<title>PhoneGap</title>
<script type="text/javascript" charset="utf-8" src="phonegap.0.9.5.js"></script>
<script type="text/javascript" charset="utf-8" src="phonegap-nfc.js"></script>

<style type="text/css">
body {
  margin: 0;
  padding: 0;
  background-color: #BADA55;
}

#tagContents {
  margin:0;
  padding-right: 20px;
  padding-left: 20px;
}

#tagContent p:first-child {
  font-size: .8em;	
}

#instructions {
	text-align: center;
	padding: 40px 10px 20px 10px;
}

#instructions p:last-child {
	padding-top: 60px;
	font-size: .8em;
}

h1 {
  font-size: 1.25em;
  text-align: center;
  border-bottom: 1px solid #000;
  padding: 0 10px 10px 10px;
}  

</style>
<script type="text/javascript">
  /*global NdefPlugin, Ndef */
  var tagMimeType = "text/pg"; 
  
  function clearScreen() {
  	document.getElementById("tagContents").innerHTML = "";
  }
  
  function showInstructions() {
  	document.getElementById("tagContents").innerHTML =
  	  "<div id='instructions'>" +
      "	<p>Scan a tag to begin.<\/p>" +
      "	<p>Expecting Mime Media Tags with a type of " + tagMimeType + ".<\/p>" +      
      "	<p>Use the menu button to clear the screen.<\/p>" +
      "<\/div>";
  }
  
  function template(record) {
      
    var recordType = Ndef.bytesToString(record.type),
      payload = Ndef.bytesToString(record.payload);
    
    if (recordType === "T") {  // TODO check TNF too
      var data = record.payload.slice(3, record.payload.length);
      payload = Ndef.bytesToString(data);
    } else if (recordType === "U") {
      var url = Ndef.bytesToString(record.payload);
      payload = "<a href='" + url + "'>" + url + "<\/a>";
    }
    
  	return ("record type: <b>" +  recordType + "<\/b>" + 
  	  "<br/>" + 
      payload
  	); 	
  }
  
  function myNfcListener(nfcEvent) {
    console.log(JSON.stringify(nfcEvent.tagData));

    clearScreen();

    var records = nfcEvent.tagData,    
      display = document.getElementById("tagContents");
      display.appendChild(document.createTextNode(
        "Scanned a NDEF tag with " + records.length + " record" + ((records.length === 1) ? "" : "s"))
      );
        
      for (var i = 0; i < records.length; i++) {
    
        var record = records[i],
          p = document.createElement('p');
                    
          p.innerHTML = template(record);
//        p.appendChild(document.createTextNode("record type: " + Ndef.bytesToString(record.type)));
//        p.appendChild(document.createElement('br'));  
//        p.appendChild(document.createTextNode(Ndef.bytesToString(record.payload)));  

        display.appendChild(p);
    }

    navigator.notification.vibrate(100);   
    //window.setTimeout(showInstructions, 20000); 
  }
  
  var ready = function () {
    
    function win() {
      console.log("Listening for tags with mime type "+ tagMimeType);
    }
    
    function fail() {
      alert('Failed to register mime type ' + tagMimeType + ' with NFC');
    }
    
    window.plugins.NdefPlugin.addMimeTypeListener(tagMimeType, myNfcListener, win, fail); 
    
    showInstructions();    
            
  };

  document.addEventListener("menubutton", showInstructions, false);

  // deviceready is being called before the plugins finish initializing
  // add setTimeout as a kludge until the real problem is fixed
  document.addEventListener('deviceready', function () { window.setTimeout(ready, 500); }, false);
     
</script>
</head>

<body>
  <h1>PhoneGap NFC Reader</h1>
  <div id="tagContents">
  </div>
</body>
</html>