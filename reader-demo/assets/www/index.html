<!DOCTYPE HTML>
<html>
<head>

<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<title>PhoneGap</title>
<script type="text/javascript" charset="utf-8" src="phonegap.0.9.5.js"></script>
<script type="text/javascript" charset="utf-8" src="phonegap-nfc.js"></script>

<style type="text/css">
body {
  margin: 0;
  padding: 0;
  background-color: #BADA55;
  color:  #fff;
}

.title {
  text-shadow: 0px -1px 1px #000;
  border-bottom: 1px solid #000;
  padding: 10px 0 10px 0;
  text-align: center;
}

.clear {
  text-align: center;
  border-bottom: 1px solid #000;
  padding-bottom: 10px;
  margin: 0;
}

#tagContents {
  margin:0;
  border-top: 1px solid #fff;
  padding: 10px;
  font-size: 200%;
}
</style>
<script type="text/javascript">
  /*global NdefPlugin, Ndef, stringToBytes */
  var tagMimeType = "text/pg"; 
  
  function myNfcListener(nfcEvent) {

    var records = nfcEvent.tagData,    
      display = document.getElementById("tagContents"),
      div = document.createElement("div");
  
      div.appendChild(document.createTextNode(new Date()));
      div.appendChild(document.createElement("br"));
      div.appendChild(document.createTextNode(
        "NDEF Message contains " + records.length + " record" + ((records.length === 1) ? "" : "s"))
      );
    
      for (var i = 0; i < records.length; i++) {
    
        var record = records[i],
          p = document.createElement('p'),
          tagDataAsString,
          recordType = NdefPlugin.bytesToString(record.type); 	 
      	 
      	 
      	 tagDataAsString =  recordType + " " + NdefPlugin.bytesToString(record.payload);
//	      if (recordType === tagMimeType) { // only print records matching our mime type (for now)
//      	  	tagDataAsString = NdefPlugin.bytesToString(record.payload);
//          } else {
//      	  	tagDataAsString = "Skipping type " + recordType;
//          }
        p.appendChild(document.createTextNode(tagDataAsString));
        div.appendChild(p);
    }
    display.insertBefore(div, display.firstChild);         
    
    // Write a tag
    var message = [
      Ndef.mimeMediaRecord(tagMimeType, stringToBytes("This is a mimeMediaMessage of type " + tagMimeType)),
      Ndef.uriRecord("http://chariotsolutions.com"),
      Ndef.textRecord("This is a test...")   
    ];
    
    NdefPlugin.writeTag(message, function () { alert("Wrote Data!"); }, function () { alert("Write failed"); });
    
  }

  document.addEventListener("ndef", myNfcListener, false);
    
  var ready = function() {
    var win = function () {      
      console.log("registered "+ tagMimeType);
      
      window.plugins.NdefPlugin.registerForWrite(function() {
      }, function() {
      	alert('did fail');
      }); 
    },

    fail = function() {
      alert('Failed to register mime type ' + tagMimeType + ' with NFC');
    };
    
    //Using setTimeout as a work around, problems with plugin initialization
    //http://groups.google.com/group/phonegap/browse_thread/thread/9c0adba823797b53
    window.setTimeout ( function() { 
      window.plugins.NdefPlugin.register(tagMimeType, win, fail);      
      } , 500 );
  };

  document.addEventListener("menubutton", function() {
  	document.getElementById("tagContents").innerHTML = "";
  }, false);

  document.addEventListener('deviceready', ready, false);
</script>
</head>

<body>
  <h1 class="title">PhoneGap NFC Reader</h1>
  <p class="clear">Hit the menu button to clear</p>
    <div id="tagContents">
    </div>
</body>
</html>