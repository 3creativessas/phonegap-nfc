<!DOCTYPE HTML>
<html>
<head>

<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<title>PhoneGap</title>
<script type="text/javascript" charset="utf-8" src="phonegap.0.9.5.js"></script>
<script type="text/javascript" charset="utf-8" src="phonegap.nfc.js"></script>

<style type="text/css">
body {
  margin: 0;
  padding: 0;
  background-color: #BADA55;
  color:  #fff;
}

.title {
  text-shadow: 0px -1px 1px #000;
  border-bottom: 1px solid #000;
  padding: 10px 0 10px 0;
  text-align: center;
}

.clear {
  text-align: center;
  border-bottom: 1px solid #000;
  padding-bottom: 10px;
  margin: 0;
}

#tagContents {
  margin:0;
  border-top: 1px solid #fff;
  padding: 10px;
  font-size: 200%;
}
</style>
<script type="text/javascript">

  var tagMimeType = "text/pg"; 
  
  // Called when an NFC Tag is scanned matching mime type
  function myNfcListener(nfcEvent) {

    var messages = nfcEvent.tagData,    
      display = document.getElementById("tagContents");    
  
    //NDEF Tags can contain multiple messages
    for (var i = 0; i < messages.length; i++) {
    
      var message = messages[i];

      var tagDataAsString = NdefPlugin.bytesToString(message.records);
      
      var p = document.createElement('p');
      p.appendChild(document.createTextNode(tagDataAsString));
      display.appendChild(p);
      display.insertBefore(p, display.firstChild);
     
      // overwrite tag value
      window.plugins.NdefPlugin.writeTag(tagMimeType, "booya", 
        function () { 
          alert("Your tag has been overwritten.");
        }, 
        function () { 
          alert("Failed to write to tag.");
        }
      );
      
    }
  }

  document.addEventListener("ndef", myNfcListener, false);
    
  var ready = function() {
    var win = function () {
      console.log("registered "+ tagMimeType);
    },

    fail = function() {
      alert('Failed to register mime type ' + tagMimeType + ' with NFC');
    };
    
    //Using setTimeout as a work around, problems with plugin initialization
    //http://groups.google.com/group/phonegap/browse_thread/thread/9c0adba823797b53
    window.setTimeout ( function() { 
      window.plugins.NdefPlugin.register(tagMimeType, win, fail); 
      } , 50 );
  };

  document.addEventListener("menubutton", function() {
  	document.getElementById("tagContents").innerHTML = "";
  }, false);

  document.addEventListener('deviceready', ready, false);
</script>
</head>

<body>
  <h1 class="title">PhoneGap NFC Reader</h1>
  <p class="clear">Hit the menu button to clear</p>
    <div id="tagContents">
    </div>
</body>
</html>